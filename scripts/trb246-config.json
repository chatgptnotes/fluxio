{
  "_comment": "TRB246 Configuration for FlowNexus - Reference Configuration",
  "_version": "1.1",
  "_created": "2026-02-01",
  "_updated": "2026-02-01",
  "_description": "Configures 6 Nivus 750 Modbus TCP devices for FlowNexus IIoT platform",
  "_note": "The built-in data_sender service has HTTPS issues. Use fluxio_sender.sh cron script instead.",
  "_setup_command": "Run: .\\setup-trb246-complete.ps1 -Password 'Lightyear@123'",

  "modbus": {
    "devices": [
      {
        "id": "device_1",
        "name": "NIVUS_750_001",
        "ip": "192.168.1.10",
        "port": 502,
        "slave_id": 1,
        "period": 300,
        "timeout": 5,
        "enabled": true
      },
      {
        "id": "device_2",
        "name": "NIVUS_750_002",
        "ip": "192.168.1.11",
        "port": 502,
        "slave_id": 1,
        "period": 300,
        "timeout": 5,
        "enabled": true
      },
      {
        "id": "device_3",
        "name": "NIVUS_750_003",
        "ip": "192.168.1.12",
        "port": 502,
        "slave_id": 1,
        "period": 300,
        "timeout": 5,
        "enabled": true
      },
      {
        "id": "device_4",
        "name": "NIVUS_750_004",
        "ip": "192.168.1.13",
        "port": 502,
        "slave_id": 1,
        "period": 300,
        "timeout": 5,
        "enabled": true
      },
      {
        "id": "device_5",
        "name": "NIVUS_750_005",
        "ip": "192.168.1.14",
        "port": 502,
        "slave_id": 1,
        "period": 300,
        "timeout": 5,
        "enabled": true
      },
      {
        "id": "device_6",
        "name": "NIVUS_750_006",
        "ip": "192.168.1.15",
        "port": 502,
        "slave_id": 1,
        "period": 300,
        "timeout": 5,
        "enabled": true
      }
    ],
    "requests": [
      {
        "_comment": "Device 1 - NIVUS_750_001 Registers",
        "device_1_flow_rate": {
          "device": "device_1",
          "name": "flow_rate",
          "function": 4,
          "first_reg": 11,
          "reg_count": 2,
          "data_type": "32bit_float3412",
          "enabled": true
        },
        "device_1_totalizer": {
          "device": "device_1",
          "name": "totalizer",
          "function": 4,
          "first_reg": 5201,
          "reg_count": 2,
          "data_type": "32bit_float3412",
          "enabled": true
        },
        "device_1_temperature": {
          "device": "device_1",
          "name": "temperature",
          "function": 4,
          "first_reg": 17,
          "reg_count": 2,
          "data_type": "32bit_float3412",
          "enabled": true
        },
        "device_1_water_level": {
          "device": "device_1",
          "name": "level",
          "function": 4,
          "first_reg": 13,
          "reg_count": 2,
          "data_type": "32bit_float3412",
          "enabled": true
        },
        "device_1_velocity": {
          "device": "device_1",
          "name": "velocity",
          "function": 4,
          "first_reg": 15,
          "reg_count": 2,
          "data_type": "32bit_float3412",
          "enabled": true
        }
      },
      {
        "_comment": "Device 2 - NIVUS_750_002 Registers",
        "device_2_flow_rate": {
          "device": "device_2",
          "name": "flow_rate",
          "function": 4,
          "first_reg": 11,
          "reg_count": 2,
          "data_type": "32bit_float3412",
          "enabled": true
        },
        "device_2_totalizer": {
          "device": "device_2",
          "name": "totalizer",
          "function": 4,
          "first_reg": 5201,
          "reg_count": 2,
          "data_type": "32bit_float3412",
          "enabled": true
        },
        "device_2_temperature": {
          "device": "device_2",
          "name": "temperature",
          "function": 4,
          "first_reg": 17,
          "reg_count": 2,
          "data_type": "32bit_float3412",
          "enabled": true
        },
        "device_2_water_level": {
          "device": "device_2",
          "name": "level",
          "function": 4,
          "first_reg": 13,
          "reg_count": 2,
          "data_type": "32bit_float3412",
          "enabled": true
        },
        "device_2_velocity": {
          "device": "device_2",
          "name": "velocity",
          "function": 4,
          "first_reg": 15,
          "reg_count": 2,
          "data_type": "32bit_float3412",
          "enabled": true
        }
      },
      {
        "_comment": "Device 3 - NIVUS_750_003 Registers",
        "device_3_flow_rate": {
          "device": "device_3",
          "name": "flow_rate",
          "function": 4,
          "first_reg": 11,
          "reg_count": 2,
          "data_type": "32bit_float3412",
          "enabled": true
        },
        "device_3_totalizer": {
          "device": "device_3",
          "name": "totalizer",
          "function": 4,
          "first_reg": 5201,
          "reg_count": 2,
          "data_type": "32bit_float3412",
          "enabled": true
        },
        "device_3_temperature": {
          "device": "device_3",
          "name": "temperature",
          "function": 4,
          "first_reg": 17,
          "reg_count": 2,
          "data_type": "32bit_float3412",
          "enabled": true
        },
        "device_3_water_level": {
          "device": "device_3",
          "name": "level",
          "function": 4,
          "first_reg": 13,
          "reg_count": 2,
          "data_type": "32bit_float3412",
          "enabled": true
        },
        "device_3_velocity": {
          "device": "device_3",
          "name": "velocity",
          "function": 4,
          "first_reg": 15,
          "reg_count": 2,
          "data_type": "32bit_float3412",
          "enabled": true
        }
      },
      {
        "_comment": "Device 4 - NIVUS_750_004 Registers",
        "device_4_flow_rate": {
          "device": "device_4",
          "name": "flow_rate",
          "function": 4,
          "first_reg": 11,
          "reg_count": 2,
          "data_type": "32bit_float3412",
          "enabled": true
        },
        "device_4_totalizer": {
          "device": "device_4",
          "name": "totalizer",
          "function": 4,
          "first_reg": 5201,
          "reg_count": 2,
          "data_type": "32bit_float3412",
          "enabled": true
        },
        "device_4_temperature": {
          "device": "device_4",
          "name": "temperature",
          "function": 4,
          "first_reg": 17,
          "reg_count": 2,
          "data_type": "32bit_float3412",
          "enabled": true
        },
        "device_4_water_level": {
          "device": "device_4",
          "name": "level",
          "function": 4,
          "first_reg": 13,
          "reg_count": 2,
          "data_type": "32bit_float3412",
          "enabled": true
        },
        "device_4_velocity": {
          "device": "device_4",
          "name": "velocity",
          "function": 4,
          "first_reg": 15,
          "reg_count": 2,
          "data_type": "32bit_float3412",
          "enabled": true
        }
      },
      {
        "_comment": "Device 5 - NIVUS_750_005 Registers",
        "device_5_flow_rate": {
          "device": "device_5",
          "name": "flow_rate",
          "function": 4,
          "first_reg": 11,
          "reg_count": 2,
          "data_type": "32bit_float3412",
          "enabled": true
        },
        "device_5_totalizer": {
          "device": "device_5",
          "name": "totalizer",
          "function": 4,
          "first_reg": 5201,
          "reg_count": 2,
          "data_type": "32bit_float3412",
          "enabled": true
        },
        "device_5_temperature": {
          "device": "device_5",
          "name": "temperature",
          "function": 4,
          "first_reg": 17,
          "reg_count": 2,
          "data_type": "32bit_float3412",
          "enabled": true
        },
        "device_5_water_level": {
          "device": "device_5",
          "name": "level",
          "function": 4,
          "first_reg": 13,
          "reg_count": 2,
          "data_type": "32bit_float3412",
          "enabled": true
        },
        "device_5_velocity": {
          "device": "device_5",
          "name": "velocity",
          "function": 4,
          "first_reg": 15,
          "reg_count": 2,
          "data_type": "32bit_float3412",
          "enabled": true
        }
      },
      {
        "_comment": "Device 6 - NIVUS_750_006 Registers",
        "device_6_flow_rate": {
          "device": "device_6",
          "name": "flow_rate",
          "function": 4,
          "first_reg": 11,
          "reg_count": 2,
          "data_type": "32bit_float3412",
          "enabled": true
        },
        "device_6_totalizer": {
          "device": "device_6",
          "name": "totalizer",
          "function": 4,
          "first_reg": 5201,
          "reg_count": 2,
          "data_type": "32bit_float3412",
          "enabled": true
        },
        "device_6_temperature": {
          "device": "device_6",
          "name": "temperature",
          "function": 4,
          "first_reg": 17,
          "reg_count": 2,
          "data_type": "32bit_float3412",
          "enabled": true
        },
        "device_6_water_level": {
          "device": "device_6",
          "name": "level",
          "function": 4,
          "first_reg": 13,
          "reg_count": 2,
          "data_type": "32bit_float3412",
          "enabled": true
        },
        "device_6_velocity": {
          "device": "device_6",
          "name": "velocity",
          "function": 4,
          "first_reg": 15,
          "reg_count": 2,
          "data_type": "32bit_float3412",
          "enabled": true
        }
      }
    ]
  },

  "data_sender": {
    "_note": "TRB246 built-in data_sender may have issues with HTTPS. Use fluxio_sender.sh cron script instead.",
    "sender1": {
      "name": "FlowNexus_API",
      "enabled": true,
      "url": "https://www.flownexus.work/api/ingest",
      "method": "post",
      "period": 300,
      "data_format": "custom",
      "content_type": "application/json",
      "tls": true,
      "headers": [
        "Content-Type: application/json",
        "x-api-key: flownexus_secure_key_2025_production"
      ]
    },
    "sender_supabase_backup": {
      "_note": "Backup configuration for direct Supabase access",
      "name": "FlowNexus_Supabase",
      "enabled": false,
      "url": "https://dzmiisuxwruoeklbkyzc.supabase.co/rest/v1/flow_data",
      "method": "post",
      "period": 300,
      "data_format": "custom",
      "content_type": "application/json",
      "headers": [
        "apikey: sb_publishable_ed4UwVUrD7rc2Qlx0Fp8sg_rdm3ctOL",
        "Authorization: Bearer YOUR_SUPABASE_SERVICE_ROLE_KEY",
        "Content-Type: application/json",
        "Prefer: return=minimal"
      ]
    }
  },

  "register_mapping": {
    "_description": "Nivus 750 Modbus Register Map - IEEE754 Float Input Registers (FC4, Measurement Place 1)",
    "_source": "Nivus PDF NF-NP_TB_Modbus_TCP-RTU_Rev04_en.pdf (Nov 2024)",
    "_byte_order": "CDAB (least significant register first) = 32bit_float3412 on TRB246",
    "registers": [
      {
        "name": "flow_rate",
        "address_1based": 11,
        "modicon_tag": 30011,
        "protocol_addr_0based": 10,
        "function_code": 4,
        "count": 2,
        "data_type": "IEEE754_Float32",
        "byte_order": "CDAB",
        "trb246_data_type": "32bit_float3412",
        "unit": "m3/s",
        "description": "Flow rate (Measurement Place 1)"
      },
      {
        "name": "level",
        "address_1based": 13,
        "modicon_tag": 30013,
        "protocol_addr_0based": 12,
        "function_code": 4,
        "count": 2,
        "data_type": "IEEE754_Float32",
        "byte_order": "CDAB",
        "trb246_data_type": "32bit_float3412",
        "unit": "m",
        "description": "Water level (Measurement Place 1)"
      },
      {
        "name": "velocity",
        "address_1based": 15,
        "modicon_tag": 30015,
        "protocol_addr_0based": 14,
        "function_code": 4,
        "count": 2,
        "data_type": "IEEE754_Float32",
        "byte_order": "CDAB",
        "trb246_data_type": "32bit_float3412",
        "unit": "m/s",
        "description": "Flow velocity (Measurement Place 1)"
      },
      {
        "name": "temperature",
        "address_1based": 17,
        "modicon_tag": 30017,
        "protocol_addr_0based": 16,
        "function_code": 4,
        "count": 2,
        "data_type": "IEEE754_Float32",
        "byte_order": "CDAB",
        "trb246_data_type": "32bit_float3412",
        "unit": "C",
        "description": "Water temperature (Measurement Place 1)"
      },
      {
        "name": "totalizer",
        "address_1based": 5201,
        "modicon_tag": 35201,
        "protocol_addr_0based": 5200,
        "function_code": 4,
        "count": 2,
        "data_type": "IEEE754_Float32",
        "byte_order": "CDAB",
        "trb246_data_type": "32bit_float3412",
        "unit": "m3",
        "description": "Totalizer volume (Measurement Place 1)"
      }
    ]
  },

  "network": {
    "trb246": {
      "ip": "192.168.1.2",
      "subnet": "255.255.255.0",
      "gateway": "192.168.1.1"
    },
    "nivus_devices": {
      "ip_range_start": "192.168.1.10",
      "ip_range_end": "192.168.1.15",
      "modbus_port": 502
    }
  },

  "uci_commands": {
    "_description": "Raw UCI commands for manual configuration",
    "example_device": [
      "uci set modbus.device_1=device",
      "uci set modbus.device_1.name='NIVUS_750_001'",
      "uci set modbus.device_1.ip='192.168.1.10'",
      "uci set modbus.device_1.port='502'",
      "uci set modbus.device_1.slave_id='1'",
      "uci set modbus.device_1.period='300'",
      "uci set modbus.device_1.enabled='1'",
      "uci commit modbus"
    ],
    "example_request_flow": [
      "uci set modbus_client.req_1_flow=request",
      "uci set modbus_client.req_1_flow.device='device_1'",
      "uci set modbus_client.req_1_flow.name='flow_rate'",
      "uci set modbus_client.req_1_flow.function='4'",
      "uci set modbus_client.req_1_flow.first_reg='11'",
      "uci set modbus_client.req_1_flow.reg_count='2'",
      "uci set modbus_client.req_1_flow.data_type='32bit_float3412'",
      "uci set modbus_client.req_1_flow.enabled='1'",
      "uci commit modbus_client"
    ],
    "example_request_totalizer": [
      "uci set modbus_client.req_1_total=request",
      "uci set modbus_client.req_1_total.device='device_1'",
      "uci set modbus_client.req_1_total.name='totalizer'",
      "uci set modbus_client.req_1_total.function='4'",
      "uci set modbus_client.req_1_total.first_reg='5201'",
      "uci set modbus_client.req_1_total.reg_count='2'",
      "uci set modbus_client.req_1_total.data_type='32bit_float3412'",
      "uci set modbus_client.req_1_total.enabled='1'",
      "uci commit modbus_client"
    ],
    "restart_services": [
      "/etc/init.d/modbus_client restart",
      "/etc/init.d/data_sender restart"
    ]
  }
}
