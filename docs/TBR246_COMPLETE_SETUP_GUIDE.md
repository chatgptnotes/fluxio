# TBR 246 Gateway - Complete Setup Guide (Out of Box)

## Overview

Step-by-step guide to configure a brand new Teltonika TBR 246 gateway to read data from Nivus 750 and send to Supabase.

**Architecture:**
```
Nivus 750          TBR 246              Supabase           FluxIO Website
    |                  |                    |                    |
    |--Modbus TCP----->|                    |                    |
    |   (every 5min)   |                    |                    |
    |                  |--HTTPS POST------->|                    |
    |                  |  (REST API)        |                    |
    |                  |                    |<---READ ON DEMAND--|
    |                  |                    |   (when opened)    |
```

---

# PART 0: CREATE SUPABASE TABLES (PREREQUISITE)

## How to Create Tables in Supabase

### Step 1: Open Supabase Dashboard

1. Go to: https://supabase.com/dashboard
2. Login to your account
3. Select your project: `aynoltymgusyasgxshng`

### Step 2: Open SQL Editor

1. In left sidebar, click **SQL Editor**
2. Click **+ New Query** button

### Step 3: Run the Schema SQL

Copy and paste this entire SQL block into the editor, then click **Run**:

```sql
-- Enable UUID extension
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- Create devices table
CREATE TABLE IF NOT EXISTS devices (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  device_id TEXT UNIQUE NOT NULL,
  device_name TEXT NOT NULL,
  device_type TEXT DEFAULT 'nivus_flow_transmitter',
  location TEXT,
  description TEXT,
  status TEXT CHECK (status IN ('active', 'inactive', 'maintenance', 'error')) DEFAULT 'active',
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  last_seen TIMESTAMPTZ,
  metadata JSONB DEFAULT '{}'::jsonb
);

-- Create flow_data table (stores all sensor readings)
CREATE TABLE IF NOT EXISTS flow_data (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  device_id TEXT NOT NULL,
  flow_rate FLOAT4,
  totalizer FLOAT8,
  temperature FLOAT4,
  pressure FLOAT4,
  battery_level FLOAT4,
  signal_strength INTEGER,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  metadata JSONB DEFAULT '{}'::jsonb,
  CONSTRAINT fk_device FOREIGN KEY (device_id) REFERENCES devices(device_id) ON DELETE CASCADE
);

-- Create indexes for better query performance
CREATE INDEX IF NOT EXISTS idx_flow_data_device_id ON flow_data(device_id);
CREATE INDEX IF NOT EXISTS idx_flow_data_created_at ON flow_data(created_at DESC);
CREATE INDEX IF NOT EXISTS idx_flow_data_device_time ON flow_data(device_id, created_at DESC);

-- Create function to update device last_seen timestamp automatically
CREATE OR REPLACE FUNCTION update_device_last_seen()
RETURNS TRIGGER AS $$
BEGIN
  UPDATE devices
  SET last_seen = NEW.created_at
  WHERE device_id = NEW.device_id;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Create trigger for updating device last_seen on new flow data
DROP TRIGGER IF EXISTS update_device_last_seen_trigger ON flow_data;
CREATE TRIGGER update_device_last_seen_trigger
  AFTER INSERT ON flow_data
  FOR EACH ROW
  EXECUTE FUNCTION update_device_last_seen();
```

### Step 4: Register Your Test Device

After the tables are created, run this to add your device:

```sql
INSERT INTO devices (device_id, device_name, device_type, location, status)
VALUES (
  'NIVUS_750_01',
  'Nivus 750 Flow Meter #1',
  'nivus_flow_transmitter',
  'Test Location',
  'active'
)
ON CONFLICT (device_id) DO NOTHING;
```

### Step 5: Verify Tables Were Created

1. In left sidebar, click **Table Editor**
2. You should see:
   - `devices` table (with 1 row: NIVUS_750_01)
   - `flow_data` table (empty, ready to receive data)

### Quick Check Query

Run this to verify everything is set up:

```sql
SELECT device_id, device_name, status FROM devices;
```

Should return:

| device_id | device_name | status |
|-----------|-------------|--------|
| NIVUS_750_01 | Nivus 750 Flow Meter #1 | active |

---

# PART 1: PHYSICAL SETUP

## Step 1: Unbox and Identify Components

Your TBR 246 box should contain:
- TBR 246 gateway unit
- Power adapter (9-30V DC)
- Ethernet cable
- Quick start guide
- Antenna(s) for cellular/WiFi (if applicable)

## Step 2: Physical Connections

```
[Power Adapter] -----> [TBR 246 PWR Port]
[Laptop] ----Ethernet----> [TBR 246 LAN Port]
[Nivus 750] ----Ethernet----> [TBR 246 LAN Port] (or same network)
```

**Connection Diagram:**
```
+-------------+     Ethernet      +-------------+     Ethernet      +-------------+
|   Laptop    |-------------------|   TBR 246   |-------------------|  Nivus 750  |
| 192.168.1.x |                   | 192.168.1.1 |                   | 192.168.1.100|
+-------------+                   +-------------+                   +-------------+
                                        |
                                        | 4G/LTE (for internet)
                                        v
                                   [Internet]
                                        |
                                        v
                                   [Supabase]
```

## Step 3: Power On

1. Connect power adapter to TBR 246
2. Wait 1-2 minutes for boot (LEDs will blink)
3. Power LED should be solid green when ready

---

# PART 2: INITIAL ACCESS

## Step 4: Connect Laptop to TBR 246

### Option A: Direct Ethernet Connection

1. Connect Ethernet cable from laptop to TBR 246 LAN port
2. Your laptop should get IP via DHCP (192.168.1.x range)
3. If not, manually set laptop IP:
   - IP: `192.168.1.100`
   - Subnet: `255.255.255.0`
   - Gateway: `192.168.1.1`

### Option B: WiFi (if TBR 246 has WiFi AP enabled)

1. Look for WiFi network: `TBR246_XXXX`
2. Default password: Usually on device label or `admin01`

## Step 5: Access Web Interface

1. Open browser on laptop
2. Navigate to: `http://192.168.1.1`
3. Login credentials (factory default):
   - **Username:** `admin`
   - **Password:** `admin01` (or check device label)

4. First login may prompt password change - set a secure password

---

# PART 3: NETWORK CONFIGURATION

## Step 6: Configure Internet Connection

### For 4G/LTE (Recommended for remote sites):

1. Insert SIM card (with data plan)
2. Go to: **Network > Mobile**
3. Enable mobile connection
4. Set APN (get from your SIM provider):
   - APN: `internet` (or provider-specific)
   - Username/Password: Usually blank
5. Save and wait for connection

### For Ethernet WAN (if available):

1. Go to: **Network > WAN**
2. Configure as DHCP client or static IP
3. Connect to your router/network

## Step 7: Verify Internet Connection

1. Go to: **Status > Overview**
2. Check "Internet" status shows connected
3. Or go to: **System > Administration > Troubleshoot**
4. Run ping test to `8.8.8.8`

---

# PART 4: TEST WITHOUT NIVUS 750 (Static Data)

Since you may not have the Nivus 750 connected yet, we can configure TBR 246 to send **static test values** to verify the Supabase connection works.

## Step 8: Skip Modbus Configuration (For Now)

Without Nivus 750, skip Modbus setup. We will send static test data instead.

---

# PART 5: DATA TO SERVER (SUPABASE) - WITH STATIC TEST DATA

## Step 9: Configure Data to Server

1. Go to: **Services > Data to Server**
2. Click **Add** to create new server

## Step 10: Server Configuration

| Setting | Value |
|---------|-------|
| **Enable** | ON |
| **Name** | `Supabase_FluxIO` |
| **Type/Protocol** | `HTTP(S)` |
| **URL** | `https://aynoltymgusyasgxshng.supabase.co/rest/v1/flow_data` |
| **Method** | `POST` |

## Step 11: Configure HTTP Headers

Add custom headers (click Add Header for each):

| Header Name | Header Value |
|-------------|--------------|
| `apikey` | `YOUR_SUPABASE_SERVICE_ROLE_KEY` |
| `Authorization` | `Bearer YOUR_SUPABASE_SERVICE_ROLE_KEY` |
| `Content-Type` | `application/json` |
| `Prefer` | `return=minimal` |

## Step 12: Configure Data Format

| Setting | Value |
|---------|-------|
| **Data Format** | `Custom` or `JSON` |
| **Period** | `30` seconds (for testing) |

### JSON Payload Template (STATIC TEST VALUES - No Nivus 750):

```json
{
  "device_id": "NIVUS_750_01",
  "flow_rate": 25.5,
  "totalizer": 15000.0,
  "temperature": 22.3,
  "signal_strength": -65,
  "metadata": {"gateway": "TBR246", "source": "static_test"}
}
```

This sends fixed test values to verify the connection works.

### JSON Payload Template (WITH Nivus 750 - Use Later):

```json
{
  "device_id": "NIVUS_750_01",
  "flow_rate": %Modbus.NIVUS_750_01.flow_rate%,
  "totalizer": %Modbus.NIVUS_750_01.totalizer%,
  "temperature": %Modbus.NIVUS_750_01.temperature%,
  "signal_strength": %GSM.Signal%,
  "metadata": {"gateway": "TBR246", "imei": "%IMEI%"}
}
```

**Note:** Variable syntax may differ by firmware version. Common alternatives:
- `${Modbus[NIVUS_750_01].flow_rate}`
- `%I/O.Modbus.NIVUS_750_01.flow_rate%`

Check TBR 246 firmware documentation for exact syntax.

## Step 13: Configure Retry Settings

| Setting | Value |
|---------|-------|
| **Retry on Fail** | Enabled |
| **Retry Count** | `3` |
| **Retry Period** | `60` seconds |
| **Store on Fail** | Enabled |
| **Max Stored Records** | `100` |

Click **Save**

---

# PART 6: TESTING AND VERIFICATION

## Step 14: Test Data to Server (From TBR 246)

1. Go to: **Services > Data to Server**
2. Find your Supabase configuration
3. Click **Test** or **Send Now** button (if available)
4. Check status shows success (HTTP 201)

## Step 15: Alternative - Test From Laptop

If TBR 246 test does not work, test from your laptop first to verify Supabase is ready.

**Open PowerShell on your laptop and run:**

```powershell
$headers = @{
    "apikey" = "YOUR_SUPABASE_SERVICE_ROLE_KEY"
    "Authorization" = "Bearer YOUR_SUPABASE_SERVICE_ROLE_KEY"
    "Content-Type" = "application/json"
    "Prefer" = "return=representation"
}
$body = '{"device_id":"NIVUS_750_01","flow_rate":25.5,"totalizer":15000.0,"temperature":22.3,"metadata":{"source":"laptop_test"}}'
Invoke-RestMethod -Uri "https://aynoltymgusyasgxshng.supabase.co/rest/v1/flow_data" -Method Post -Headers $headers -Body $body
```

**Expected result:** Returns the inserted record with an `id` field.

**Or use the test script:**

```powershell
# Run from the project root
.\scripts\test-supabase-insert.ps1
```

## Step 16: Check Supabase

1. Open: https://supabase.com/dashboard/project/aynoltymgusyasgxshng/editor
2. Select `flow_data` table
3. Look for new records with `device_id = NIVUS_750_01`
4. Should see records from both laptop test and TBR 246

## Step 17: Check FluxIO Dashboard

1. Open: http://localhost:3000/dashboard (or your deployed URL)
2. Verify device shows as "Online"
3. Check flow rate and totalizer values display

---

# PART 7: MODBUS CONFIGURATION (When Nivus 750 is Available)

## Step 18: Configure Modbus TCP Master on TBR 246

**Navigate to:** Services > Modbus > Modbus TCP Master

### Add TCP Slave (Nivus 750)

| Setting | Value |
|---------|-------|
| Enable | ON |
| Name | NIVUS_750_01 |
| IP Address | `192.168.1.100` (your Nivus IP) |
| Port | 502 |
| Unit ID | 1 |
| Timeout | 5000 ms |
| Period | 300000 ms (5 minutes) |

### Add Register Requests

**Request 1: Flow Rate**

| Setting | Value |
|---------|-------|
| Name | flow_rate |
| Function | 3 (Read Holding Registers) |
| First Register | 0 |
| Register Count | 2 |
| Data Type | 32-bit Float, Big Endian |

**Request 2: Totalizer**

| Setting | Value |
|---------|-------|
| Name | totalizer |
| Function | 3 (Read Holding Registers) |
| First Register | 6 |
| Register Count | 2 |
| Data Type | 32-bit Float, Big Endian |

**Request 3: Temperature**

| Setting | Value |
|---------|-------|
| Name | temperature |
| Function | 3 (Read Holding Registers) |
| First Register | 10 |
| Register Count | 2 |
| Data Type | 32-bit Float, Big Endian |

## Step 19: Update JSON Payload to Use Modbus Values

Update the Data to Server JSON payload:

```json
{
  "device_id": "NIVUS_750_01",
  "flow_rate": %Modbus.NIVUS_750_01.flow_rate%,
  "totalizer": %Modbus.NIVUS_750_01.totalizer%,
  "temperature": %Modbus.NIVUS_750_01.temperature%,
  "signal_strength": %GSM.Signal%,
  "metadata": {"gateway": "TBR246", "imei": "%IMEI%", "source": "modbus"}
}
```

---

# PART 8: SAVE CONFIGURATION

## Step 20: Save Configuration

1. Go to: **System > Administration > Backup**
2. Click **Download** to save configuration file
3. Store safely - useful for restoring or cloning to other gateways

---

# TROUBLESHOOTING

## Cannot Access 192.168.1.1

- Check Ethernet cable connection
- Disable WiFi on laptop
- Try different browser
- Factory reset: Hold reset button 10+ seconds

## Modbus Values Show 0 or NaN

- Verify Nivus 750 IP address
- Check Modbus TCP is enabled on Nivus 750
- Try different register addresses
- Try Little Endian byte order instead of Big Endian
- Check firewall not blocking port 502

## Data Not Reaching Supabase

- Verify internet connection on TBR 246
- Check headers are exactly correct (no extra spaces)
- Verify device_id exists in Supabase devices table
- Check TBR 246 logs: **Status > System Log**

## HTTP 401 Unauthorized

- Service role key may be incorrect
- Check both `apikey` and `Authorization` headers are set

## HTTP 409 Conflict

- Device `NIVUS_750_01` does not exist in devices table
- Run this SQL in Supabase:

```sql
INSERT INTO devices (device_id, device_name, status)
VALUES ('NIVUS_750_01', 'Nivus 750 Flow Meter', 'active')
ON CONFLICT DO NOTHING;
```

---

# QUICK REFERENCE

| Item | Value |
|------|-------|
| TBR 246 Default IP | `192.168.1.1` |
| Default Login | `admin` / `admin01` |
| Modbus TCP Port | `502` |
| Supabase URL | `https://aynoltymgusyasgxshng.supabase.co/rest/v1/flow_data` |
| Device ID | `NIVUS_750_01` |
| Test Period | `30` seconds |
| Production Period | `300` seconds (5 min) |

---

# DATA FLOW SUMMARY

```
Every 5 minutes (production) / 30 seconds (testing):
1. TBR 246 reads Modbus registers from Nivus 750 (or uses static values)
2. TBR 246 POSTs JSON to Supabase REST API
3. Supabase inserts into flow_data table
4. Device last_seen is updated automatically (trigger)

When you open FluxIO:
1. Website queries Supabase for flow_data
2. Displays current and historical readings
```

---

# SUMMARY CHECKLIST

| Step | Action | Status |
|------|--------|--------|
| 0a | Open Supabase SQL Editor | [ ] |
| 0b | Run schema SQL to create tables | [ ] |
| 0c | Register NIVUS_750_01 device | [ ] |
| 0d | Verify tables in Table Editor | [ ] |
| 1 | Unbox TBR 246 and connect power | [ ] |
| 2 | Connect laptop via Ethernet | [ ] |
| 3 | Access web interface at 192.168.1.1 | [ ] |
| 4 | Configure internet (4G or Ethernet WAN) | [ ] |
| 5 | Configure Data to Server with Supabase URL | [ ] |
| 6 | Add HTTP headers (apikey, Authorization, etc.) | [ ] |
| 7 | Configure JSON payload (static or Modbus) | [ ] |
| 8 | Test connection (Send Now button) | [ ] |
| 9 | Verify data in Supabase Table Editor | [ ] |
| 10 | Check FluxIO dashboard | [ ] |
| 11 | Save TBR 246 configuration backup | [ ] |

---

# SUPPORT RESOURCES

- [Supabase REST API Documentation](https://supabase.com/docs/guides/api)
- [Teltonika TBR 246 Wiki](https://wiki.teltonika-networks.com/view/TBR246)
- [NivuFlow 750 Product Page](https://www.nivus.com/en/products/flow-measurement/polluted-media/flowmeter/nivuflow-750-flowmeter)
- [FluxIO Documentation](./README.md)

---

*Version 1.4 | January 24, 2026 | fluxio*
