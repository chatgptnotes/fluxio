# TBR 246 Gateway - Direct Supabase Integration

## Overview

This guide configures Teltonika TBR 246 gateway to read data from Nivus 750 flow transmitter via **Modbus TCP** and write **directly to Supabase database** every 5 minutes. FlowNexus website reads from Supabase to display data.

**Key Benefit:** The FlowNexus website does not need to be running 24/7. Data is stored directly in the database.

---

## Architecture

```
Nivus 750          TBR 246              Supabase           FlowNexus Website
    |                  |                    |                    |
    |--Modbus TCP----->|                    |                    |
    |   (every 5min)   |                    |                    |
    |                  |--HTTPS POST------->|                    |
    |                  |  (REST API)        |                    |
    |                  |                    |<---READ ON DEMAND--|
    |                  |                    |   (when opened)    |
```

---

## Prerequisites

- Teltonika TBR 246 gateway with firmware 7.x or later
- Nivus 750 flow transmitter with Modbus TCP enabled
- Supabase project with database credentials
- Network connectivity between all devices

---

## Step 1: Set Up Supabase Database Schema

### 1.1 Open Supabase SQL Editor

1. Go to your Supabase project dashboard
2. Navigate to **SQL Editor** in the left sidebar
3. Click **New Query**

### 1.2 Run the Database Schema

The complete schema is in `supabase/migrations/20240101000000_initial_schema.sql`. Run this in the SQL editor.

For a quick setup, run this minimal schema:

```sql
-- Enable UUID extension
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- Create devices table
CREATE TABLE IF NOT EXISTS devices (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  device_id TEXT UNIQUE NOT NULL,
  device_name TEXT NOT NULL,
  device_type TEXT DEFAULT 'nivus_flow_transmitter',
  location TEXT,
  description TEXT,
  status TEXT CHECK (status IN ('active', 'inactive', 'maintenance', 'error')) DEFAULT 'active',
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  last_seen TIMESTAMPTZ,
  metadata JSONB DEFAULT '{}'::jsonb
);

-- Create flow_data table (stores all sensor readings)
CREATE TABLE IF NOT EXISTS flow_data (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  device_id TEXT NOT NULL,
  flow_rate FLOAT4,
  totalizer FLOAT8,
  temperature FLOAT4,
  pressure FLOAT4,
  battery_level FLOAT4,
  signal_strength INTEGER,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  metadata JSONB DEFAULT '{}'::jsonb,
  CONSTRAINT fk_device FOREIGN KEY (device_id) REFERENCES devices(device_id) ON DELETE CASCADE
);

-- Create indexes for better query performance
CREATE INDEX IF NOT EXISTS idx_flow_data_device_id ON flow_data(device_id);
CREATE INDEX IF NOT EXISTS idx_flow_data_created_at ON flow_data(created_at DESC);
CREATE INDEX IF NOT EXISTS idx_flow_data_device_time ON flow_data(device_id, created_at DESC);

-- Create function to update device last_seen timestamp automatically
CREATE OR REPLACE FUNCTION update_device_last_seen()
RETURNS TRIGGER AS $$
BEGIN
  UPDATE devices
  SET last_seen = NEW.created_at
  WHERE device_id = NEW.device_id;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Create trigger for updating device last_seen on new flow data
DROP TRIGGER IF EXISTS update_device_last_seen_trigger ON flow_data;
CREATE TRIGGER update_device_last_seen_trigger
  AFTER INSERT ON flow_data
  FOR EACH ROW
  EXECUTE FUNCTION update_device_last_seen();
```

### 1.3 Register Your Nivus 750 Device

```sql
INSERT INTO devices (device_id, device_name, device_type, location, status)
VALUES (
  'NIVUS_750_01',
  'Nivus 750 Flow Meter #1',
  'nivus_flow_transmitter',
  'Your Location Here',
  'active'
);
```

---

## Step 2: Configure Supabase for Direct API Access

### 2.1 Get Your Supabase Credentials

In Supabase dashboard, go to **Settings > API**:

1. **Project URL:** `https://xxxxx.supabase.co`
2. **anon public key:** `eyJhbGciOi...` (long string)
3. **service_role key:** `eyJhbGciOi...` (for unrestricted access)

**Use the service_role key** for TBR 246 since it bypasses Row Level Security.

### 2.2 Test Direct Insert

Test that you can insert directly to Supabase:

**Windows PowerShell:**
```powershell
$headers = @{
    "apikey" = "YOUR_SUPABASE_SERVICE_ROLE_KEY"
    "Authorization" = "Bearer YOUR_SUPABASE_SERVICE_ROLE_KEY"
    "Content-Type" = "application/json"
    "Prefer" = "return=minimal"
}
$body = @{
    device_id = "NIVUS_750_01"
    flow_rate = 15.5
    totalizer = 12500.75
    temperature = 21.3
} | ConvertTo-Json

Invoke-RestMethod -Uri "https://aynoltymgusyasgxshng.supabase.co/rest/v1/flow_data" -Method Post -Headers $headers -Body $body
```

**Or use the test script:**
```powershell
.\scripts\test-supabase-insert.ps1
```

**curl (Linux/macOS/Git Bash):**
```bash
curl -X POST "https://aynoltymgusyasgxshng.supabase.co/rest/v1/flow_data" \
  -H "apikey: YOUR_SUPABASE_SERVICE_ROLE_KEY" \
  -H "Authorization: Bearer YOUR_SUPABASE_SERVICE_ROLE_KEY" \
  -H "Content-Type: application/json" \
  -H "Prefer: return=minimal" \
  -d '{
    "device_id": "NIVUS_750_01",
    "flow_rate": 15.5,
    "totalizer": 12500.75,
    "temperature": 21.3
  }'
```

**Or use the test script:**
```bash
./scripts/test-supabase-insert.sh
```

**Expected Response:** Empty body with status `201 Created`

Verify in Supabase Table Editor > flow_data that the record appeared.

---

## Step 3: Access TBR 246 Web Interface

1. Connect to TBR 246 network (default IP: `192.168.1.1`)
2. Open browser: `http://192.168.1.1`
3. Login with credentials (default: admin/admin01)

---

## Step 4: Find Nivus 750 IP and Modbus Settings

### On the Nivus 750 Device:

1. Navigate to: **Menu > Communication > Ethernet**
2. Note the IP address (e.g., `192.168.1.100`)
3. Navigate to: **Menu > Communication > Modbus TCP**
4. Note the port (default: `502`) and Unit ID (usually `1`)

### Find Register Addresses:

Navigate to: **Menu > Communication > Modbus > Register Assignment**

| Parameter | Register Address | Data Type |
|-----------|-----------------|-----------|
| Flow Rate | 0 or 1 | Float32 |
| Totalizer | 2 or 4 | Float32 |
| Temperature | 8 or 10 | Float32 |

### Common Nivus 750 Modbus Register Map:

| Register | Parameter | Unit | Data Type |
|----------|-----------|------|-----------|
| 0-1 | Flow Rate | m3/h | Float32 BE |
| 2-3 | Flow Velocity | m/s | Float32 BE |
| 4-5 | Level | mm | Float32 BE |
| 6-7 | Totalizer (low) | m3 | Float32 BE |
| 8-9 | Totalizer (high) | m3 | Float32 BE |
| 10-11 | Temperature | C | Float32 BE |

**Note:** Register addresses may vary by firmware. Consult your Nivus 750 documentation or contact NIVUS support.

---

## Step 5: Configure Modbus TCP Master on TBR 246

**Navigate to:** Services > Modbus > Modbus TCP Master

### 5.1 Add TCP Slave (Nivus 750)

| Setting | Value |
|---------|-------|
| Enable | ON |
| Name | NIVUS_750_01 |
| IP Address | `192.168.1.100` (your Nivus IP) |
| Port | 502 |
| Unit ID | 1 |
| Timeout | 5000 ms |
| Period | 300000 ms (5 minutes) |

### 5.2 Add Register Requests

**Request 1: Flow Rate**

| Setting | Value |
|---------|-------|
| Name | flow_rate |
| Function | 3 (Read Holding Registers) |
| First Register | 0 |
| Register Count | 2 |
| Data Type | 32-bit Float, Big Endian |

**Request 2: Totalizer**

| Setting | Value |
|---------|-------|
| Name | totalizer |
| Function | 3 (Read Holding Registers) |
| First Register | 6 |
| Register Count | 2 |
| Data Type | 32-bit Float, Big Endian |

**Request 3: Temperature**

| Setting | Value |
|---------|-------|
| Name | temperature |
| Function | 3 (Read Holding Registers) |
| First Register | 10 |
| Register Count | 2 |
| Data Type | 32-bit Float, Big Endian |

---

## Step 6: Configure Data to Server (Direct to Supabase)

**Navigate to:** Services > Data to Server

### 6.1 Add New Server Configuration

| Setting | Value |
|---------|-------|
| Name | Supabase_Direct |
| Protocol | HTTPS |
| URL | `https://aynoltymgusyasgxshng.supabase.co/rest/v1/flow_data` |
| Method | POST |

### 6.2 Set Collection Period (5 minutes)

| Setting | Value |
|---------|-------|
| Data Collection Period | 300 seconds |
| Retry on Fail | Enabled |
| Retry Period | 60 seconds |
| Store on Fail | Enabled |
| Max Stored Records | 100 |

### 6.3 Configure HTTP Headers

Add these custom headers:

```
apikey: YOUR_SUPABASE_SERVICE_ROLE_KEY
Authorization: Bearer YOUR_SUPABASE_SERVICE_ROLE_KEY
Content-Type: application/json
Prefer: return=minimal
```

**Important:** This is the `service_role` key (not the `anon` key) which bypasses RLS.

### 6.4 Configure JSON Payload Template

```json
{
  "device_id": "NIVUS_750_01",
  "flow_rate": %Modbus.NIVUS_750_01.flow_rate%,
  "totalizer": %Modbus.NIVUS_750_01.totalizer%,
  "temperature": %Modbus.NIVUS_750_01.temperature%,
  "signal_strength": %RSSI%,
  "metadata": {"gateway_imei": "%IMEI%", "source": "TBR246_direct"}
}
```

**Note:** The exact variable syntax depends on your TBR 246 firmware version. Check the Teltonika documentation for your specific version.

### 6.5 Alternative Variable Syntax (Firmware Dependent)

Some TBR 246 firmware versions use different syntax:

```json
{
  "device_id": "NIVUS_750_01",
  "flow_rate": ${Modbus[NIVUS_750_01].flow_rate},
  "totalizer": ${Modbus[NIVUS_750_01].totalizer},
  "temperature": ${Modbus[NIVUS_750_01].temperature},
  "signal_strength": ${GSM.RSSI},
  "metadata": {"gateway_imei": "${Device.IMEI}", "source": "TBR246_direct"}
}
```

---

## Step 7: Alternative - Use FlowNexus API Endpoint

If you prefer to use the FlowNexus API instead of direct Supabase access:

### 7.1 Configure Data to Server for FlowNexus API

| Setting | Value |
|---------|-------|
| URL | `https://your-flownexus-domain.vercel.app/api/ingest` |
| Method | POST |

### 7.2 HTTP Headers for FlowNexus API

```
x-api-key: YOUR_API_SECRET_KEY
Content-Type: application/json
```

### 7.3 JSON Payload for FlowNexus API

```json
{
  "device_id": "NIVUS_750_01",
  "flow_rate": %Modbus.NIVUS_750_01.flow_rate%,
  "totalizer": %Modbus.NIVUS_750_01.totalizer%,
  "temperature": %Modbus.NIVUS_750_01.temperature%,
  "signal_strength": %RSSI%,
  "metadata": {"gateway_imei": "%IMEI%", "source": "TBR246_api"}
}
```

**Benefits of FlowNexus API:**
- Alert rule evaluation happens on ingestion
- Automatic device status updates
- Validation and error handling
- Audit logging

---

## Step 8: Verify Data Flow

### 8.1 Check Modbus Communication

In TBR 246: **Status > Modbus**
- Verify registers show numeric values
- Check for communication errors
- Confirm polling interval is correct

### 8.2 Check Supabase Table

1. Open Supabase > Table Editor > flow_data
2. Wait 5 minutes
3. Refresh and verify new records appear

### 8.3 Check FlowNexus Dashboard

1. Open your FlowNexus website
2. Navigate to Devices page
3. Data should appear from Supabase

### 8.4 Monitor with SQL Query

```sql
-- Check recent data
SELECT * FROM flow_data
WHERE device_id = 'NIVUS_750_01'
ORDER BY created_at DESC
LIMIT 10;

-- Check device last_seen
SELECT device_id, device_name, last_seen, status
FROM devices
WHERE device_id = 'NIVUS_750_01';

-- Check data count per day
SELECT
  DATE(created_at) as date,
  COUNT(*) as readings
FROM flow_data
WHERE device_id = 'NIVUS_750_01'
GROUP BY DATE(created_at)
ORDER BY date DESC;
```

---

## Data Flow Summary

```
Every 5 minutes:
1. TBR 246 reads Modbus registers from Nivus 750
2. TBR 246 POSTs JSON to Supabase REST API
3. Supabase inserts into flow_data table
4. Device last_seen is updated automatically (trigger)

When you open FlowNexus:
1. Website queries Supabase for flow_data
2. Displays current and historical readings
```

---

## Supabase REST API Reference

**Base URL:** `https://aynoltymgusyasgxshng.supabase.co/rest/v1`

**Insert single record:**
```
POST /flow_data
Headers:
  apikey: SERVICE_ROLE_KEY
  Authorization: Bearer SERVICE_ROLE_KEY
  Content-Type: application/json
  Prefer: return=minimal
Body: {"device_id": "...", "flow_rate": 12.5, ...}
```

**Response:** `201 Created` (empty body with `return=minimal`)

**Insert multiple records:**
```
POST /flow_data
Headers:
  apikey: SERVICE_ROLE_KEY
  Authorization: Bearer SERVICE_ROLE_KEY
  Content-Type: application/json
  Prefer: return=minimal
Body: [
  {"device_id": "...", "flow_rate": 12.5},
  {"device_id": "...", "flow_rate": 13.2}
]
```

---

## Troubleshooting

### 401 Unauthorized from Supabase

- Verify the API key is correct (use service_role, not anon)
- Check `apikey` and `Authorization` headers are both set
- Ensure no extra spaces in the key

### 404 Not Found

- Verify URL is correct: `/rest/v1/flow_data`
- Table must exist in Supabase
- Check for typos in the project reference

### 400 Bad Request

- Check JSON format is valid
- Verify device_id exists in devices table (foreign key constraint)
- Check column names match exactly
- Ensure numeric values are not quoted

### 409 Conflict (Foreign Key Violation)

The device_id must exist in the devices table first. Register the device:

```sql
INSERT INTO devices (device_id, device_name, status)
VALUES ('NIVUS_750_01', 'Nivus 750 Flow Meter', 'active')
ON CONFLICT (device_id) DO NOTHING;
```

### Data Not Appearing

- Check TBR 246 Status > Data to Server for errors
- Verify internet connectivity on TBR 246
- Check Supabase logs (Database > Logs)
- Verify the gateway can reach Supabase (HTTPS on port 443)

### Modbus Values Show 0 or NaN

- Try different register addresses
- Try different byte order (Little Endian instead of Big Endian)
- Verify Unit ID matches Nivus config
- Check Modbus TCP is enabled on Nivus 750
- Verify network connectivity between TBR 246 and Nivus 750

### SSL/TLS Errors

- Ensure TBR 246 firmware is up to date
- Check system time is correct on TBR 246
- Verify TLS 1.2 or higher is supported

---

## Security Considerations

### Using service_role Key

The `service_role` key has full database access. For better security in production:

1. **Option 1: Database Function**
   Create a stored procedure for inserts with minimal permissions.

2. **Option 2: Edge Function**
   Create a Supabase Edge Function as a proxy with validation.

3. **Option 3: Custom RLS Policy**
   Create a role with INSERT-only permissions on flow_data.

### Example: RLS Policy for Gateway Access

```sql
-- Create a policy that allows inserts from service role
CREATE POLICY "Allow gateway inserts" ON flow_data
  FOR INSERT
  WITH CHECK (true);

-- Or create a specific gateway role
CREATE ROLE gateway_role;
GRANT INSERT ON flow_data TO gateway_role;
```

For initial setup and testing, the service_role key is acceptable.

---

## Finding Nivus 750 Register Addresses

If register addresses are not documented:

1. **Check Device Menu:** Menu > Communication > Modbus > Register Assignment
2. **Contact NIVUS:** Email info@nivus.com with your device serial number
3. **Use Modbus Scanner:** QModMaster or ModRSsim to scan registers 0-100
4. **Check Documentation:** NivuFlow 750 Operating Instructions, Chapter "Communication"

---

## Summary Checklist

| Step | Action | Status |
|------|--------|--------|
| 1 | Run SQL schema in Supabase | [ ] |
| 2 | Register device in devices table | [ ] |
| 3 | Get Supabase service_role key | [ ] |
| 4 | Test direct insert with curl/PowerShell | [ ] |
| 5 | Configure TBR 246 Modbus TCP Master | [ ] |
| 6 | Configure TBR 246 Data to Server (Supabase URL) | [ ] |
| 7 | Verify data appears in Supabase | [ ] |
| 8 | Verify FlowNexus displays the data | [ ] |

---

## Key Configuration Values Summary

| Item | Value |
|------|-------|
| Supabase URL | `https://aynoltymgusyasgxshng.supabase.co/rest/v1/flow_data` |
| API Key | Service role key (see headers section above) |
| Device ID | `NIVUS_750_01` |
| Collection Period | 300 seconds (5 minutes) |
| Modbus Port | 502 |
| Modbus Unit ID | 1 |
| HTTP Method | POST |
| Content-Type | application/json |

---

## Multiple Devices Setup

To add multiple Nivus 750 devices:

### 1. Register Each Device

```sql
INSERT INTO devices (device_id, device_name, location, status) VALUES
  ('NIVUS_750_01', 'Nivus 750 Flow Meter #1', 'Building A', 'active'),
  ('NIVUS_750_02', 'Nivus 750 Flow Meter #2', 'Building B', 'active'),
  ('NIVUS_750_03', 'Nivus 750 Flow Meter #3', 'Building C', 'active')
ON CONFLICT (device_id) DO NOTHING;
```

### 2. Configure Each as Modbus Slave

In TBR 246, add each Nivus 750 with unique:
- Name (matching device_id)
- IP Address

### 3. Create Separate Data to Server Entries

Either:
- One server config per device with unique device_id in payload
- One server config with all devices in array payload

---

## Support Resources

- [Supabase REST API Documentation](https://supabase.com/docs/guides/api)
- [Teltonika TBR 246 Wiki](https://wiki.teltonika-networks.com/view/TBR246)
- [NivuFlow 750 Product Page](https://www.nivus.com/en/products/flow-measurement/polluted-media/flowmeter/nivuflow-750-flowmeter)
- [FlowNexus Documentation](./README.md)

---

*Version 1.4 | January 24, 2026 | flownexus*
